{% extends "base.html" %}

{% block title %}Logs des TempÃ©ratures{% endblock %}

{% block head %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
<script src="https://hammerjs.github.io/dist/hammer.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.2.0"></script>


<!-- jQuery pour AJAX -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<style>
    canvas {
        max-width: 100%;
    }

    #logChart {
        max-height: 500px !important;
    }
</style>
{% endblock %}

{% block content %}
<!-- Toast pour le statut de l'Arduino -->
<div id="arduinoToast" class="toast align-items-center text-white bg-info border-0 position-fixed top-0 end-0 m-3"
    role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex">
        <div class="toast-body">
            <span id="arduinoStatusText">VÃ©rification de la connexion Ã  l'Arduino...</span>
        </div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"
            aria-label="Close"></button>
    </div>
</div>

<!-- Toast pour les erreurs -->
<div id="errorToast" class="toast align-items-center text-white bg-danger border-0 position-fixed top-0 end-0 m-3"
    role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex">
        <div class="toast-body">
            <span id="errorMessageText"></span>
        </div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"
            aria-label="Close"></button>
    </div>
</div>

<div class="container">
    <h1 class="text-center">ðŸ“Š Logs des TempÃ©ratures</h1>

    <!-- SÃ©lecteur de plage de temps -->
    <div class="text-center my-3">
        <label for="timeFilter">Filtrer par :</label>
        <select id="timeFilter" class="form-select d-inline-block w-auto">
            <option value="3h" selected>DerniÃ¨res 3h</option>
            <option value="24h">DerniÃ¨res 24h</option>
            <option value="7d">Derniers 7 jours</option>
            <option value="30d">Derniers 30 jours</option>
        </select>
    </div>

    <!-- Graphique -->
    <canvas id="logChart"></canvas>

</div>
{% endblock %}

{% block scripts %}
<script>
    let consigneAmbiance = 21; // Valeur par dÃ©faut, sera mise Ã  jour
    let consignePlancher = 28; // Valeur par dÃ©faut, sera mise Ã  jour

    $(document).ready(function () {
        let ctx = document.getElementById("logChart").getContext("2d");
        let logChart = new Chart(ctx, {
            type: "line",
            data: {
                labels: [],
                datasets: [
                    { label: "Plancher DÃ©part", data: [], borderColor: "red", pointStyle: false, fill: false, tension: 0.4 },
                    { label: "Plancher Retour", data: [], borderColor: "blue", pointStyle: false, fill: false, tension: 0.4 },
                    { label: "DÃ©part Alim", data: [], borderColor: "green", pointStyle: false, fill: false, tension: 0.4 },
                    { label: "Ambiance", data: [], borderColor: "orange", pointStyle: false, fill: false, tension: 0.4 }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        type: "time",
                        time: {
                            unit: "hour",
                            tooltipFormat: "dd/MM/yyyy HH:mm", // âœ… Format 24h franÃ§ais
                            displayFormats: {
                                minute: "HH:mm",
                                hour: "HH:mm",
                                day: "dd/MM",
                                month: "MM/yyyy"
                            }
                        },
                    },
                    y: { beginAtZero: false }
                },
                plugins: {
                    annotation: {
                        annotations: {
                            lineConsigneAmbiance: {
                                type: 'line',
                                yMin: 0, // Initialisation
                                yMax: 0, // Sera mis Ã  jour dynamiquement
                                borderColor: 'purple',
                                borderWidth: 2,
                                label: {
                                    content: "Consigne Ambiance",
                                    enabled: true,
                                    position: "start"
                                }
                            },
                            lineConsignePlancher: {
                                type: 'line',
                                yMin: 0, // Initialisation
                                yMax: 0, // Sera mis Ã  jour dynamiquement
                                borderColor: 'brown',
                                borderWidth: 2,
                                label: {
                                    content: "Consigne Plancher",
                                    enabled: true,
                                    position: "start"
                                }
                            }
                        }
                    },
                    zoom: {
                        pan: {
                            enabled: true,   // âœ… Active le dÃ©placement du graphe
                            mode: 'x',       // âœ… DÃ©placement horizontal uniquement
                            //modifierKey: "ctrl", // ðŸ”¹ Ajoute un modificateur (ex : maintenir CTRL pour dÃ©placer)
                            speed: 0.5,      // ðŸ”¹ Rend le dÃ©placement plus fluide
                            threshold: 10    // ðŸ”¹ Ã‰vite les dÃ©placements trop brusques
                        },
                        zoom: {
                            wheel: {
                                enabled: true,
                                speed: 0.1
                            },
                            pinch: {
                                enabled: true
                            },
                            mode: "x",
                        }
                    }
                }
            }
        });

        $("#logChart").after('<p id="loading" class="text-center">ðŸ“¡ Chargement des donnÃ©es...</p>');

        function fetchLogs(period = "3h") {
            $.getJSON(`/api/logs?period=${period}`, function (data) {
                $("#loading").remove();
                let labels = [], tempPlancherDepart = [], tempPlancherRetour = [], tempDepartAlim = [], tempAmbiance = [];
                GetArduinoInputs();//mise Ã  jour des consignes

                data.forEach(log => {
                    let dateObj = new Date(log.timestamp);
                    labels.push(dateObj);
                    tempPlancherDepart.push(log.temp_plancher_depart);
                    tempPlancherRetour.push(log.temp_plancher_retour);
                    tempDepartAlim.push(log.temp_depart_alim);
                    tempAmbiance.push(log.temp_ambiance);
                });

                logChart.data.labels = labels;
                logChart.data.datasets[0].data = tempPlancherDepart;
                logChart.data.datasets[1].data = tempPlancherRetour;
                logChart.data.datasets[2].data = tempDepartAlim;
                logChart.data.datasets[3].data = tempAmbiance;

                // Mettre Ã  jour les lignes des consignes
                logChart.options.plugins.annotation.annotations.lineConsigneAmbiance.yMin = consigneAmbiance;
                logChart.options.plugins.annotation.annotations.lineConsigneAmbiance.yMax = consigneAmbiance;

                logChart.options.plugins.annotation.annotations.lineConsignePlancher.yMin = consignePlancher;
                logChart.options.plugins.annotation.annotations.lineConsignePlancher.yMax = consignePlancher;

                logChart.update();
            }).fail(function () {
                $("#loading").remove();
                alert("âŒ Erreur : impossible de rÃ©cupÃ©rer les logs.");
            });

        }


        $("#timeFilter").change(function () {
            fetchLogs($(this).val());
        });

        fetchLogs();  // Chargement initial
    });

    function GetArduinoInputs() {
        let nocache = "&nocache=" + Math.random() * 1000000;
        let request = new XMLHttpRequest();
        request.onreadystatechange = function () {
            if (this.readyState == 4) {
                if (this.status == 200) {
                    try {
                        let data = JSON.parse(this.responseText);

                        if (data.temp_plancher_depart !== undefined) {

                            // Mise Ã  jour des input_ambiance et input_plancher
                            consigneAmbiance = data.consigne_ambiance;
                            consignePlancher = data.consigne_plancher;

                        }

                        hideError();
                    } catch (e) {
                        console.error("Erreur de parsing JSON:", e);
                        showError("DonnÃ©es invalides reÃ§ues de l'Arduino.");
                    }
                } else {
                    showError("L'Arduino ne rÃ©pond pas. VÃ©rifiez la connexion !");
                }
            }
        };

        request.onerror = function () {
            showError("Erreur rÃ©seau. Impossible de contacter l'Arduino.");
        };

        request.open("GET", "http://192.168.1.111:7777/ajax_inputs" + nocache, true);
        request.send();
        setTimeout(GetArduinoInputs, 10000);
    }

    function showError(message) {
        let errorToastEl = document.getElementById("errorToast");
        let errorMessageText = document.getElementById("errorMessageText");

        if (errorToastEl && errorMessageText) {
            errorMessageText.textContent = message;
            let errorToast = new bootstrap.Toast(errorToastEl);
            errorToast.show();
        }
    }

    function hideError() {
        let errorToastEl = document.getElementById("errorToast");
        if (errorToastEl) {
            let errorToast = new bootstrap.Toast(errorToastEl);
            errorToast.hide();
        }
    }

    document.addEventListener("DOMContentLoaded", function () {
        GetArduinoInputs();

        var arduinoToastEl = document.getElementById("arduinoToast");
        var arduinoToast = new bootstrap.Toast(arduinoToastEl, { delay: 5000 });

        fetch("/arduino_status")
            .then(response => response.json())
            .then(data => {
                if (data.status === "OK") {
                    document.getElementById("arduinoStatusText").textContent = data.message;
                    arduinoToast.show();
                } else {
                    showError(data.message);
                }
            })
            .catch(error => {
                showError("Erreur de connexion Ã  l'Arduino.");
            });
    });

</script>
{% endblock %}